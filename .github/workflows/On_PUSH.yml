name: On Push CI

on:
  push:
    branches:
    - '*'

jobs:

  # build:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v3
  #   - name: Docker Login
  #     run: docker login -u ${{secrets.REGISTRY_USER}} -p ${{secrets.REGISTRY_PASS}}
  #   - name: Build the Docker image
  #     run: docker build -t sdf_first:suiteapp .
  #   - name: Add tag to push
  #     run : docker tag sdf_first:suiteapp akashc026/test_node:latest
  #   - name: Push Docker image
  #     run : docker push akashc026/test_node:latest


  validate_test:
  
    # needs: build
    runs-on: ubuntu-latest
    container:
      image: akashc026/test_node:latest
      options: --user root -v ${{ github.workspace }}:/zap/wrk/:rw
      credentials:
        username: ${{secrets.REGISTRY_USER}}
        password: ${{secrets.REGISTRY_PASS}}
    env:
      REALM_TECHNICAL: ${{ secrets.REALM_TECHNICAL }}
      TOKEN_TECHNICAL: ${{ secrets.TOKEN_TECHNICAL }}
      SECRET_TECHNICAL: ${{ secrets.SECRET_TECHNICAL }}

    steps:
    - uses: actions/checkout@v3
    - name: npm get
      run : npm ci
    - name: Unit Test (Jest)
      run : npm run test
    - name: suitecloud
      run : suitecloud --version
    - name: Dependency Suiteapp
      run : sudo suitecloud project:adddependencies
    - name : Install sudo prompt
      run : npm install sudo-prompt
    # - name: Validate Suiteapp
    #   run : suitecloud account:savetoken --account ${{ secrets.SuperSecret }} --authid "cisdf" --tokenid ${{ secrets.SuperSecret }} --tokensecret ${{ secrets.SuperSecret }}
    - name: Account setup through the script
      run : npm run validate